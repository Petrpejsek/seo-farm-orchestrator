# üö® ALERTING PRAVIDLA PRO SEO FARM
# Prometheus alerting rules pro monitoring kritick√Ωch stav≈Ø

groups:
  - name: seo_farm_critical
    rules:
      # Worker je down
      - alert: SEOFarmWorkerDown
        expr: up{job="seo-farm-worker"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "SEO Farm Worker je nedostupn√Ω"
          description: "Worker proces neodpov√≠d√° v√≠ce ne≈æ 1 minutu"

      # Vysok√° chybovost workflow
      - alert: SEOFarmHighWorkflowErrorRate
        expr: |
          (
            rate(seo_farm_workflows_total{status="error"}[5m]) /
            rate(seo_farm_workflows_total[5m])
          ) * 100 > 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Vysok√° chybovost workflow (>10%)"
          description: "{{ $value | humanizePercentage }} workflow selh√°v√° posledn√≠ch 5 minut"

      # LLM timeouty
      - alert: SEOFarmLLMTimeouts
        expr: |
          (
            rate(seo_farm_llm_requests_total{status="error"}[10m]) /
            rate(seo_farm_llm_requests_total[10m])
          ) * 100 > 50
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Vysok√° chybovost LLM request≈Ø (>50%)"
          description: "{{ $value | humanizePercentage }} LLM request≈Ø selh√°v√° posledn√≠ch 10 minut"

  - name: seo_farm_warning
    rules:
      # Dlouh√© workflow
      - alert: SEOFarmSlowWorkflow
        expr: |
          histogram_quantile(0.95, 
            rate(seo_farm_workflow_duration_seconds_bucket[10m])
          ) > 1200
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pomal√© workflow (>20 min)"
          description: "95% workflow trv√° d√©le ne≈æ 20 minut"

      # Vysok√© vyu≈æit√≠ CPU
      - alert: SEOFarmHighCPU
        expr: seo_farm_system_cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Vysok√© vyu≈æit√≠ CPU (>80%)"
          description: "CPU vyu≈æit√≠ je {{ $value }}% posledn√≠ch 5 minut"

      # Vysok√© vyu≈æit√≠ pamƒõti
      - alert: SEOFarmHighMemory
        expr: seo_farm_system_memory_usage_percent > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Vysok√© vyu≈æit√≠ pamƒõti (>85%)"
          description: "Pamƒõ≈• vyu≈æit√≠ je {{ $value }}% posledn√≠ch 5 minut"

      # Vysok√© vyu≈æit√≠ disku
      - alert: SEOFarmHighDisk
        expr: seo_farm_system_disk_usage_percent > 90
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Vysok√© vyu≈æit√≠ disku (>90%)"
          description: "Disk vyu≈æit√≠ je {{ $value }}%"

      # Hlubok√° fronta
      - alert: SEOFarmDeepQueue
        expr: seo_farm_queue_depth > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Hlubok√° fronta (>10 √∫kol≈Ø)"
          description: "{{ $labels.queue_name }} fronta obsahuje {{ $value }} √∫kol≈Ø"

      # ≈Ω√°dn√° aktivita
      - alert: SEOFarmNoActivity
        expr: |
          increase(seo_farm_worker_activities_total[30m]) == 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "≈Ω√°dn√° aktivita posledn√≠ch 30 minut"
          description: "Worker nezpracoval ≈æ√°dn√© aktivity posledn√≠ch 30 minut"

  - name: seo_farm_info
    rules:
      # Statistika workflow
      - record: seo_farm:workflow_success_rate_5m
        expr: |
          (
            rate(seo_farm_workflows_total{status="success"}[5m]) /
            rate(seo_farm_workflows_total[5m])
          ) * 100

      # Pr≈Ømƒõrn√° doba workflow
      - record: seo_farm:workflow_avg_duration_5m
        expr: |
          rate(seo_farm_workflow_duration_seconds_sum[5m]) /
          rate(seo_farm_workflow_duration_seconds_count[5m])

      # LLM response time percentily
      - record: seo_farm:llm_response_time_p95_5m
        expr: |
          histogram_quantile(0.95,
            rate(seo_farm_llm_response_time_seconds_bucket[5m])
          )

      - record: seo_farm:llm_response_time_p99_5m
        expr: |
          histogram_quantile(0.99,
            rate(seo_farm_llm_response_time_seconds_bucket[5m])
          )